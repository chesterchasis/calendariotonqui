<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Trabajo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <style>
        /* --- Variables de Color --- */
        :root {
            --bg-color-soft: #f8fafc;
            --color-td: #f59e0b;
            --color-tn: #4b5563;
            --color-l: #22c55e;
            --color-vac: #0ea5e9;
            --color-hotel: #a855f7;
            --color-flag-sk-blue: #0b4ea2;
            --color-flag-sk-red: #ee1c25;
            --color-flag-es-red: #aa151b;
            --color-flag-es-yellow: #f1bf00;
            --color-dance: #ec4899;
            --color-default-icon2: #8b5cf6;
            --color-current-day-border: #3b82f6;
            --color-weekend-bg-vibrant: #fffbeb; /* Amarillo pastel para findes */
            --color-month-bg-alt: #fdfdfd;
        }

        /* --- Estilos Generales --- */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color-soft); margin: 0; min-height: 100vh; }
        .button { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .button:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .button-primary { background-color: #4a5568; color: white; }
        .button-primary:hover { background-color: #2d3748; }
        .button-secondary { background-color: white; color: #4b5563; border-color: #d1d5db; }
        .button-secondary:hover { background-color: #f9fafb; }

        /* --- Aplicaci√≥n Principal --- */
        #calendar-app { max-width: 1600px; margin: 0 auto; padding: 1rem 0; }

        /* --- Controles Superiores --- */
        .controls-container { display: flex; justify-content: center; padding: 1rem 2rem; margin-bottom: 1.5rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); max-width: calc(1600px - 4rem); margin-left: auto; margin-right: auto; }
        .year-navigation { display: flex; align-items: center; gap: 0.8rem; }
        #current-year { font-size: 1.5rem; font-weight: bold; color: #1f2937; min-width: 80px; text-align: center; }

        /* --- Calendario Anual --- */
        .calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            padding: 0 2rem 2rem 2rem;
        }
        .month {
            border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .calendar-container .month:nth-child(even) { background-color: var(--color-month-bg-alt); }
        .calendar-container .month:nth-child(odd) { background-color: white; }
        .month:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.09); }
        .month-header { background-color: #6b7280; color: white; padding: 0.4rem; text-align: center; font-weight: 600; font-size: 0.9rem; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 0.2rem; }
        .day-header { font-weight: 600; font-size: 0.9rem; color: #6b7280; padding-bottom: 0.2rem; }
        .day { padding: 0.8rem; font-size: 1rem; border-top: 1px solid #f3f4f6; position: relative; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; background-color: transparent; min-height: 40px; transition: opacity 0.3s ease; }
        .day.empty { background-color: #f9fafb; border-top: none; opacity: 0.6; }
        /* Estilo para fines de semana (Anual) */
        .day.weekend-day {
            background-color: var(--color-weekend-bg-vibrant); /* Amarillo pastel */
        }
        .day span { position: absolute; top: 2px; right: 2px; background-color: rgba(255, 255, 255, 0.7); border-radius: 50%; padding: 0 2px; font-size: 0.6rem; z-index: 2; color: #374151; font-weight: normal; }
        .day.current-day { border: 2px solid var(--color-current-day-border); font-weight: bold; }
        /* Emojis en vista anual */
        .day .icon-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative; }
        .day .icon-container .main-icon-wrapper { font-size: 1rem; line-height: 1; z-index: 1; text-align: center; }
        /* Indicador si icono 2 tiene override */
        .day .secondary-indicator-wrapper { /* Contenedor indicador */ }
        .day .secondary-indicator { position: absolute; bottom: 2px; left: 5px; width: 6px; height: 6px; border-radius: 50%; z-index: 1; border: 1px solid white; background-color: var(--color-default-icon2); }

        /* --- Modal Mes Grande --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 0; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); position: relative; width: 95%; max-width: 800px; transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; position: relative; display: flex; justify-content: center; align-items: center; }
        .modal-title { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .modal-close-btn { position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); background: none; border: none; font-size: 1.8rem; color: #6b7280; cursor: pointer; line-height: 1; padding: 0.25rem; }
        .modal-close-btn:hover { color: #1f2937; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        /* Grid del mes en modal */
        .modal-days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .modal-day-header { font-weight: bold; font-size: 0.9rem; color: #6b7280; padding-bottom: 0.5rem; text-align: center; }
        /* Celda d√≠a modal */
        .modal-day {
            min-height: 70px; border: 1px solid #e5e7eb; border-radius: 0.5rem; position: relative;
            padding: 0.5rem; background-color: #f8f8f8; cursor: pointer;
            transition: background-color 0.2s, opacity 0.3s ease; overflow: hidden;
            display: flex; align-items: center; justify-content: flex-start;
        }
        /* Estilo para fines de semana (Modal) */
        .modal-day.weekend-day {
            background-color: var(--color-weekend-bg-vibrant); /* Amarillo pastel */
        }
        .modal-day:hover { background-color: #f0f0f0; } /* Mantener hover */
        .modal-day.empty { background-color: #f9fafb; border-color: #f9fafb; cursor: default; display: block; }
        /* N√∫mero d√≠a modal */
        .modal-day span {
            position: absolute; top: 4px; right: 5px; font-size: 0.8rem; font-weight: bold; color: #374151;
            background-color: rgba(255, 255, 255, 0.7); padding: 1px 4px; border-radius: 50%; z-index: 2;
        }
        /* Contenedor de emojis en modal */
        .modal-day .icons-wrapper {
            display: flex; flex-direction: row; align-items: center; justify-content: flex-start;
            gap: 0.4rem; width: auto; padding-left: 5px; position: static; transform: none; height: auto; z-index: 1;
            font-size: 1.8rem;
            line-height: normal;
        }
        /* Wrapper para cada emoji individual en modal */
        .modal-day .status-icon-wrapper {
             position: static; display: flex; align-items: center; justify-content: center; width: auto;
             font-size: inherit;
        }
        .modal-day.current-day { border: 2px solid var(--color-current-day-border); font-weight: bold; }

        /* --- Estilo para D√≠as Pasados (Aplica a Anual y Modal) --- */
        .day.past-day, .modal-day.past-day {
             opacity: 0.4;
             cursor: default;
        }
        /* Asegurar que el d√≠a actual no se aten√∫e aunque sea pasado */
        .day.current-day.past-day, .modal-day.current-day.past-day {
            opacity: 1;
        }

        /* --- Modal Editor de D√≠a --- */
        #day-editor-modal .modal-content { max-width: 550px; }
        #day-editor-modal .modal-body { display: flex; flex-direction: column; gap: 1.5rem; }
        .editor-section { border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; }
        .editor-section h3 { font-weight: 600; margin-bottom: 0.8rem; color: #374151; }
        /* Estilos para Select */
        .editor-section select {
            width: 100%; padding: 0.6rem 0.8rem; border: 1px solid #d1d5db; border-radius: 0.5rem;
            background-color: white; font-size: 1rem; cursor: pointer; appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%236b7280%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em;
        }
        .editor-section select:focus {
            outline: 2px solid transparent; outline-offset: 2px; border-color: var(--color-current-day-border);
            box-shadow: 0 0 0 2px var(--color-current-day-border);
        }
        #day-editor-modal .modal-footer {
            padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex;
            justify-content: space-between; gap: 0.5rem; background-color: #f9fafb;
        }

        /* --- ESTILOS RESPONSIVOS (Para emojis en modal de mes) --- */
        @media (max-width: 639px) {
            .modal-day {
                min-height: 105px;
                align-items: flex-start;
                padding-top: 0.8rem;
            }
            .modal-day .icons-wrapper {
                flex-direction: column; align-items: flex-start; gap: 0.3rem;
                padding-left: 0; margin-top: 1.2rem;
                font-size: 2.4rem;
            }
             .modal-day span {
                 font-size: 0.7rem; top: 2px; right: 3px;
             }
             .day .icon-container .main-icon-wrapper {
                 font-size: 1rem;
             }
        }
        /* --- FIN ESTILOS RESPONSIVOS --- */

    </style>
</head>
<body>
    <div id="calendar-app">
        <div class="controls-container">
            <div class="year-navigation">
                <button id="prev-year" class="button button-secondary" aria-label="A√±o anterior"><i class="fas fa-chevron-left"></i></button>
                <span id="current-year" aria-live="polite">2025</span>
                <button id="next-year" class="button button-secondary" aria-label="A√±o siguiente"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        <div id="calendar-container" class="calendar-container"></div>
    </div>

    <div id="month-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                 <h2 id="modal-title" class="modal-title">Mes</h2>
                 <button id="month-modal-close-btn" class="modal-close-btn" aria-label="Cerrar modal">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                 </div>
        </div>
    </div>

    <div id="day-editor-modal" class="modal-overlay">
         <div class="modal-content">
             <div class="modal-header">
                 <h2 id="day-editor-title" class="modal-title">Editar D√≠a</h2>
                 <button id="day-editor-close-btn" class="modal-close-btn" aria-label="Cerrar editor">&times;</button>
             </div>
             <div id="day-editor-body" class="modal-body">
                 <div class="editor-section">
                     <h3>Icono 1 (Horario Base / Extra)</h3>
                     <div id="status-selection-1">
                         </div>
                 </div>
                  <div class="editor-section">
                     <h3>Icono 2 (Extra)</h3>
                     <div id="status-selection-2">
                         </div>
                 </div>
             </div>
              <div class="modal-footer">
                 <button id="day-editor-cancel" class="button button-secondary">Cancelar</button>
                 <button id="day-editor-save" class="button button-primary">Guardar</button>
              </div>
         </div>
    </div>


    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
  apiKey: "AIzaSyD0zentUNqgouFTVD3i3wKLruRQkgMZt_Y",
  authDomain: "calentonqui.firebaseapp.com",
  databaseURL: "https://calentonqui-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calentonqui",
  storageBucket: "calentonqui.firebasestorage.app",
  messagingSenderId: "386155002525",
  appId: "1:386155002525:web:b8eb1f054ef2cb8c5a7274"
};

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Obtener instancia de Firestore

        // --- Elementos DOM ---
        const calendarAppDiv = document.getElementById('calendar-app');
        const calendarContainer = document.getElementById('calendar-container');
        const currentYearSpan = document.getElementById('current-year');
        const prevYearBtn = document.getElementById('prev-year');
        const nextYearBtn = document.getElementById('next-year');
        const monthModal = document.getElementById('month-modal');
        const monthModalTitle = document.getElementById('modal-title');
        const monthModalBody = document.getElementById('modal-body');
        const monthModalCloseBtn = document.getElementById('month-modal-close-btn');
        const dayEditorModal = document.getElementById('day-editor-modal');
        const dayEditorTitle = document.getElementById('day-editor-title');
        const dayEditorBody = document.getElementById('day-editor-body');
        const statusSelectionDiv1 = document.getElementById('status-selection-1');
        const statusSelectionDiv2 = document.getElementById('status-selection-2');
        const dayEditorSaveBtn = document.getElementById('day-editor-save');
        const dayEditorCancelBtn = document.getElementById('day-editor-cancel');
        const dayEditorCloseBtn = document.getElementById('day-editor-close-btn');

        // --- Estado de la Aplicaci√≥n ---
        let displayedYear = new Date().getFullYear();
        let dayData = {}; // Objeto que contiene los datos de los d√≠as para el a√±o mostrado
        let selectedDateForEdit = null;
        const today = new Date();
        today.setHours(0,0,0,0); // Normalizar a medianoche para comparaciones precisas
        let unsubscribeRealtimeListener = null; // Variable para guardar la funci√≥n de cancelaci√≥n del listener

        // --- Constantes y Configuraci√≥n ---
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["Lu", "Ma", "Mi", "Ju", "Vi", "S√°", "Do"];
        const baseWorkPattern = ['TD', 'TD', 'TD', 'L', 'L', 'TD', 'TD', 'L', 'L', 'L', 'TN', 'TN', 'L', 'L', 'TN', 'TN', 'TN', 'L', 'L', 'TN', 'TN', 'L', 'L', 'L', 'TD', 'TD', 'L', 'L'];
        const patternLength = baseWorkPattern.length;
        const sequenceStartDate = new Date(2025, 0, 3);
        const utcStartDate = new Date(Date.UTC(sequenceStartDate.getFullYear(), sequenceStartDate.getMonth(), sequenceStartDate.getDate()));

        // --- Opciones de Estado con Emojis ---
        const BASE_STATUS_OPTIONS = {
            'TD': { label: 'D√≠a', icon: 'fa-sun', emoji: '‚òÄÔ∏è' },
            'TN': { label: 'Noche', icon: 'fa-moon', emoji: 'üåô' },
            'L': { label: 'Libre', icon: 'fa-house', emoji: 'üè°' }
        };
        const DEFAULT_ICON2_STATUS = 'HOME_PURPLE';
        const DEFAULT_ICON2_OPTIONS = {
             [DEFAULT_ICON2_STATUS]: { label: 'Casa', icon: 'fa-house', class: 'icon2-default', emoji: 'üè°' }
        };
        const EXTRA_STATUS_OPTIONS = {
            'VAC': { label: 'Vacaciones', icon: 'fa-plane', emoji: '‚úàÔ∏è' },
            'HOTEL': { label: 'Hotel', icon: 'fa-hotel', emoji: 'üè®' },
            'FLAG_SK': { label: 'Eslovaquia', icon: 'flag-sk-svg', emoji: 'üá∏üá∞' },
            'FLAG_ES': { label: 'Espa√±a', icon: 'flag-es-svg', emoji: 'üá™üá∏' },
            'DANCE': { label: 'Bailar', icon: 'fa-person-dancing', emoji: 'üíÉ' }
        };

        // --- Funciones de Datos (CON FIRESTORE) ---

        /**
         * Obtiene los datos de los d√≠as para un a√±o espec√≠fico desde Firestore.
         * @param {number} year - El a√±o para el cual obtener los datos.
         * @returns {Promise<object>} Una promesa que resuelve con el objeto dayData para ese a√±o.
         */
        async function fetchDataForYear(year) {
            console.log(`Fetching data for year ${year} from Firestore...`);
            const yearDocRef = db.collection('calendars').doc(year.toString());
            try {
                const docSnap = await yearDocRef.get();
                if (docSnap.exists) {
                    console.log("Document data:", docSnap.data());
                    return docSnap.data().days || {};
                } else {
                    console.log(`No document found for year ${year} in Firestore.`);
                    return {};
                }
            } catch (error) {
                console.error(`Error getting document for year ${year}:`, error);
                return {};
            }
        }

        /**
         * Actualiza el estado de un d√≠a espec√≠fico en Firestore (M√©todo Simplificado v2).
         * @param {string} dateString - La fecha en formato 'YYYY-MM-DD'.
         * @param {string|null} newIcon1 - El nuevo c√≥digo para el icono 1, o null/"" para limpiar.
         * @param {string|null} newIcon2 - El nuevo c√≥digo para el icono 2, o null/"" para limpiar.
         * @returns {Promise<void>}
         */
        async function updateDayStatus(dateString, newIcon1, newIcon2) {
            console.log(`Updating Firestore for ${dateString}: Icon1=${newIcon1}, Icon2=${newIcon2}`);
            const yearDocRef = db.collection('calendars').doc(displayedYear.toString());

            // 1. Crear una copia del objeto global dayData para modificarlo
            //    Usamos JSON.parse(JSON.stringify(...)) para una copia profunda y evitar problemas de referencia
            const updatedFullDayData = JSON.parse(JSON.stringify(dayData));

            // 2. Modificar la entrada para el d√≠a espec√≠fico en la copia
            let dayInfo = updatedFullDayData[dateString] || {}; // Obtener o crear entrada para el d√≠a

            if (newIcon1 === "" || newIcon1 === null) {
                delete dayInfo.icon1;
            } else {
                dayInfo.icon1 = newIcon1;
            }
            if (newIcon2 === "" || newIcon2 === null) {
                delete dayInfo.icon2;
            } else {
                dayInfo.icon2 = newIcon2;
            }

            // 3. Decidir si guardar el objeto modificado o borrar la entrada del d√≠a
            if (Object.keys(dayInfo).length === 0) {
                // Si no quedan iconos, borrar la entrada completa para este d√≠a de la copia
                delete updatedFullDayData[dateString];
            } else {
                // Si quedan iconos, actualizar la entrada para este d√≠a en la copia
                updatedFullDayData[dateString] = dayInfo;
            }

            // 4. Guardar TODO el objeto 'days' modificado en Firestore
            try {
                console.log("Attempting to save to Firestore:", { days: updatedFullDayData });
                // Usar set con merge:true para actualizar solo el campo 'days'
                await yearDocRef.set({ days: updatedFullDayData }, { merge: true });
                console.log(`Firestore updated successfully for year ${displayedYear} (day ${dateString})`);

                // Actualizar el estado local AHORA que sabemos que se guard√≥
                // (onSnapshot tambi√©n lo har√°, pero esto asegura consistencia inmediata)
                dayData = updatedFullDayData;

                // Refrescar UI (onSnapshot deber√≠a hacerlo, pero esto da respuesta inmediata)
                // refreshUI(); // Descomentar si onSnapshot no es suficiente

            } catch (error) {
                console.error(`Error updating Firestore for year ${displayedYear} (day ${dateString}):`, error);
                // Lanzar el error para que el listener del bot√≥n lo capture si es necesario
                throw error;
            }
        }


        // --- L√≥gica Horario Base ---
        function getDefaultStatusForDay(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const currentDate = new Date(Date.UTC(year, month - 1, day));
            if (currentDate < utcStartDate) { return 'L'; }
            const timeDiff = currentDate.getTime() - utcStartDate.getTime();
            const dayDifference = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const patternIndex = dayDifference % patternLength;
            return baseWorkPattern[patternIndex];
        }

        // --- Funciones de Renderizado ---
        function createDayCellHTML(day, monthIndex, year, isModal = false, isWeekend = false) {
             const date = new Date(year, monthIndex, day); date.setHours(0,0,0,0);
             const dateString = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
             const isCurrentDay = date.getTime() === today.getTime();
             let cellClass = isModal ? 'modal-day' : 'day';
             if (isCurrentDay) cellClass += ' current-day';
             if (isWeekend) cellClass += ' weekend-day';

             let cellHTML = `<div class="${cellClass}" data-date="${dateString}">`;
             if (isModal) {
                 cellHTML += `<span>${day}</span><div class="icons-wrapper"><span class="status-icon-wrapper status-icon-wrapper-1"></span><span class="status-icon-wrapper status-icon-wrapper-2"></span></div>`;
             } else {
                 cellHTML += `<span>${day}</span><div class="icon-container"><span class="main-icon-wrapper"></span><span class="secondary-indicator-wrapper"></span></div>`;
             }
             cellHTML += `</div>`; return cellHTML;
        }

        function applyDayMarkings(dayCell) {
            try {
                const dateString = dayCell.dataset.date;
                if (!dateString) return;
                const dayInfo = dayData[dateString] || {}; // Usa el dayData global
                const isModal = dayCell.classList.contains('modal-day');

                const date = new Date(dateString + "T00:00:00");
                if (date < today) { dayCell.classList.add('past-day'); }
                else { dayCell.classList.remove('past-day'); }

                const defaultStatusIcon1 = getDefaultStatusForDay(dateString);
                const defaultStatusIcon2 = DEFAULT_ICON2_STATUS;
                const finalStatusIcon1 = dayInfo.icon1 || defaultStatusIcon1;
                const finalStatusIcon2 = dayInfo.icon2 || defaultStatusIcon2;

                let icon1Info = EXTRA_STATUS_OPTIONS[finalStatusIcon1] || BASE_STATUS_OPTIONS[finalStatusIcon1];
                let icon2Info = EXTRA_STATUS_OPTIONS[finalStatusIcon2] || DEFAULT_ICON2_OPTIONS[finalStatusIcon2];

                if (isModal) {
                    const iconWrapper1 = dayCell.querySelector('.status-icon-wrapper-1');
                    const iconWrapper2 = dayCell.querySelector('.status-icon-wrapper-2');
                    if (iconWrapper1) { iconWrapper1.textContent = icon1Info?.emoji || ''; iconWrapper1.title = icon1Info?.label || ''; }
                    else { console.warn("Wrapper 1 no encontrado", dayCell); }
                    if (iconWrapper2) { iconWrapper2.textContent = icon2Info?.emoji || ''; iconWrapper2.title = icon2Info?.label || ''; }
                    else { console.warn("Wrapper 2 no encontrado", dayCell); }
                } else {
                    const mainIconWrapper = dayCell.querySelector('.main-icon-wrapper');
                    const secondaryIndicatorWrapper = dayCell.querySelector('.secondary-indicator-wrapper');
                    if (mainIconWrapper) { mainIconWrapper.textContent = icon1Info?.emoji || ''; mainIconWrapper.title = icon1Info?.label || ''; }
                    else { console.warn("Main wrapper no encontrado", dayCell); }
                    if (secondaryIndicatorWrapper) {
                        secondaryIndicatorWrapper.innerHTML = '';
                        if (dayInfo.icon2) { secondaryIndicatorWrapper.innerHTML = `<span class="secondary-indicator" title="Estado extra a√±adido"></span>`; }
                    } else { console.warn("Secondary wrapper no encontrado", dayCell); }
                }
            } catch (error) { console.error(`Error aplicando marcas al d√≠a ${dayCell?.dataset?.date}:`, error, error.stack, dayCell); }
        }

        function generateSingleMonthGrid(year, monthIndex) {
             let gridHTML = `<div class="modal-days-grid">`;
             dayNames.forEach(dayName => { gridHTML += `<div class="modal-day-header">${dayName}</div>`; });
             const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
             const firstDayOfMonth = new Date(year, monthIndex, 1).getDay();
             const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
             for (let i = 0; i < offset; i++) { gridHTML += `<div class="modal-day empty"></div>`; }
             for (let day = 1; day <= daysInMonth; day++) {
                 const currentDate = new Date(year, monthIndex, day);
                 const dayOfWeek = currentDate.getDay();
                 const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                 gridHTML += createDayCellHTML(day, monthIndex, year, true, isWeekend);
             }
             gridHTML += `</div>`;
             const tempDiv = document.createElement('div');
             tempDiv.innerHTML = gridHTML;
             tempDiv.querySelectorAll('.modal-day[data-date]').forEach(applyDayMarkings);
             return tempDiv.firstElementChild;
        }

        function renderAnnualCalendar(year) {
            console.log(`Rendering annual calendar for ${year}`);
            calendarContainer.innerHTML = '';
            currentYearSpan.textContent = year;

            let calendarHTML = '';
            for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
                calendarHTML += `<div class="month" data-month="${monthIndex}" data-year="${year}"><div class="month-header">${monthNames[monthIndex]}</div><div class="days-grid">`;
                dayNames.forEach(dayName => { calendarHTML += `<div class="day-header">${dayName.charAt(0)}</div>`; });
                const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, monthIndex, 1).getDay();
                const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                for (let i = 0; i < offset; i++) { calendarHTML += `<div class="day empty"></div>`; }
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, monthIndex, day);
                    const dayOfWeek = currentDate.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    calendarHTML += createDayCellHTML(day, monthIndex, year, false, isWeekend);
                }
                calendarHTML += `</div></div>`;
            }
            calendarContainer.innerHTML = calendarHTML;

            if (calendarContainer.childElementCount > 0) {
                 calendarContainer.querySelectorAll('.day[data-date]').forEach(applyDayMarkings);
            } else { console.warn("Calendario anual vac√≠o post-generaci√≥n."); }
        }

        function populateDayEditor(dateString) {
            selectedDateForEdit = dateString;
            const dayInfo = dayData[dateString] || {};
            const currentStatusIcon1 = dayInfo.icon1;
            const currentStatusIcon2 = dayInfo.icon2;

            try {
                const dateObj = new Date(dateString + 'T00:00:00');
                dayEditorTitle.textContent = `Editar ${dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            } catch(e) { dayEditorTitle.textContent = `Editar ${dateString}`; console.error("Error formateando fecha:", e); }

            statusSelectionDiv1.innerHTML = '';
            statusSelectionDiv2.innerHTML = '';

            const select1 = document.createElement('select');
            select1.id = 'icon1-select';
            select1.className = 'block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50';
            const clearOption1 = document.createElement('option');
            clearOption1.value = ""; clearOption1.textContent = "--- Limpiar (Horario Base) ---";
            select1.appendChild(clearOption1);
            Object.entries(EXTRA_STATUS_OPTIONS).forEach(([code, { label, emoji }]) => {
                const option = document.createElement('option'); option.value = code; option.textContent = `${emoji} ${label}`;
                if (currentStatusIcon1 === code) option.selected = true; select1.appendChild(option);
            });
            if (currentStatusIcon1 === undefined) clearOption1.selected = true;
            statusSelectionDiv1.appendChild(select1);

            const select2 = document.createElement('select');
            select2.id = 'icon2-select';
            select2.className = 'block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50';
            const clearOption2 = document.createElement('option');
            clearOption2.value = ""; clearOption2.textContent = "--- Limpiar (Casa por defecto) ---";
            select2.appendChild(clearOption2);
            Object.entries(EXTRA_STATUS_OPTIONS).forEach(([code, { label, emoji }]) => {
                const option = document.createElement('option'); option.value = code; option.textContent = `${emoji} ${label}`;
                if (currentStatusIcon2 === code) option.selected = true; select2.appendChild(option);
            });
            if (currentStatusIcon2 === undefined) clearOption2.selected = true;
            statusSelectionDiv2.appendChild(select2);
        }

        function openMonthModal(year, monthIndex) {
            if (!monthModal || !monthModalTitle || !monthModalBody) { console.error("CRITICAL: Elementos modal mes no encontrados."); return; }
            try {
                if (isNaN(monthIndex) || isNaN(year) || monthIndex < 0 || monthIndex > 11) { console.error("Error: A√±o/mes inv√°lido", year, monthIndex); return; }
                monthModalTitle.textContent = `${monthNames[monthIndex]} ${year}`;
                monthModalBody.innerHTML = '';
                const monthGridElement = generateSingleMonthGrid(year, monthIndex); // Ya aplica marcas
                if (monthGridElement instanceof Node) {
                    monthModalBody.appendChild(monthGridElement);
                    monthModal.classList.add('visible');
                } else { console.error("Error: generateSingleMonthGrid no devolvi√≥ nodo."); }
            } catch (error) { console.error(`Error abriendo modal mes ${monthIndex + 1}/${year}:`, error, error.stack); }
        }

        /**
         * Refresca la interfaz de usuario (vista anual y modal si est√° abierto).
         * Se llama despu√©s de cambios en los datos (locales o de Firebase).
         */
        function refreshUI() {
             console.log("Refreshing UI...");
             // 1. Redibujar siempre la vista anual completa
             renderAnnualCalendar(displayedYear); // Usa renderAnnualCalendar que aplica marcas

             // 2. Si el modal del mes est√° visible, redibujar su contenido
             if (monthModal && monthModal.classList.contains('visible')) {
                 console.log("Month modal is visible, refreshing its content.");
                 const titleParts = monthModalTitle.textContent.split(' ');
                 const monthName = titleParts[0];
                 const year = parseInt(titleParts[1]);
                 const monthIndex = monthNames.indexOf(monthName);

                 if (monthIndex !== -1 && !isNaN(year)) {
                     // Solo regenerar si el a√±o/mes del modal coincide con el actual
                     if (year === displayedYear) {
                         const newMonthGrid = generateSingleMonthGrid(year, monthIndex); // Ya aplica marcas
                         monthModalBody.innerHTML = '';
                         monthModalBody.appendChild(newMonthGrid);
                     } else {
                         console.log("Modal open for different year/month than data change, not refreshing modal content.");
                     }
                 } else {
                     console.warn("Could not determine year/month from modal title to refresh.");
                 }
             }
        }

        /**
         * Configura el listener de Firebase para el a√±o especificado.
         * @param {number} year El a√±o a escuchar.
         */
        function setupRealtimeListener(year) {
            if (unsubscribeRealtimeListener) {
                console.log("Detaching previous listener...");
                unsubscribeRealtimeListener();
                unsubscribeRealtimeListener = null;
            }

            console.log(`Setting up Firestore listener for year ${year}...`);
            const yearDocRef = db.collection('calendars').doc(year.toString());

            unsubscribeRealtimeListener = yearDocRef.onSnapshot(doc => {
                console.log("Realtime update received from Firestore for year", year);
                if (doc.exists) {
                    dayData = doc.data().days || {};
                } else {
                    console.log(`Document for year ${year} does not exist in Firestore.`);
                    dayData = {};
                }
                if (year === displayedYear) {
                    refreshUI();
                } else {
                     console.log(`Listener update for year ${year}, but currently displaying ${displayedYear}. UI not refreshed.`);
                }
            }, error => {
                console.error(`Error in Firestore listener for year ${year}: `, error);
            });
        }


        // --- Handlers de Eventos ---
        prevYearBtn.addEventListener('click', async () => { // Hacer async
            displayedYear--;
            dayData = await fetchDataForYear(displayedYear); // Esperar datos
            setupRealtimeListener(displayedYear); // Configurar listener para el nuevo a√±o
            refreshUI(); // Redibujar todo
        });
        nextYearBtn.addEventListener('click', async () => { // Hacer async
            displayedYear++;
            dayData = await fetchDataForYear(displayedYear); // Esperar datos
            setupRealtimeListener(displayedYear); // Configurar listener para el nuevo a√±o
            refreshUI(); // Redibujar todo
        });

        calendarContainer.addEventListener('click', (event) => {
            const monthDiv = event.target.closest('.month'); if (!monthDiv) return;
            try {
                const monthIndex = parseInt(monthDiv.dataset.month);
                const year = parseInt(monthDiv.dataset.year);
                openMonthModal(year, monthIndex);
            }
            catch(error) { console.error("Error obteniendo datos mes:", error); }
        });

        monthModalCloseBtn.addEventListener('click', () => { if (monthModal) monthModal.classList.remove('visible'); });
        monthModal.addEventListener('click', (event) => { if (event.target === monthModal) monthModal.classList.remove('visible'); });

        monthModalBody.addEventListener('click', (event) => {
             const dayDiv = event.target.closest('.modal-day:not(.empty)');
             if (dayDiv) {
                 if (dayDiv.classList.contains('past-day')) return;
                 const dateString = dayDiv.dataset.date;
                 if (dateString) {
                     populateDayEditor(dateString);
                     if (dayEditorModal) dayEditorModal.classList.add('visible');
                     else console.error("Error: Modal editor no encontrado.");
                 } else { console.warn("D√≠a clickeado sin data-date.", dayDiv); }
             }
        });

        // Event listener del bot√≥n Guardar (MODIFICADO con try/finally)
        dayEditorSaveBtn.addEventListener('click', async () => {
            if (!selectedDateForEdit) { console.error("Error: No hay fecha seleccionada."); return; }
            const selectElement1 = statusSelectionDiv1.querySelector('select');
            const selectElement2 = statusSelectionDiv2.querySelector('select');
            if (!selectElement1 || !selectElement2) { console.error("Error: Selectores no encontrados."); return; }

            const newStatus1 = selectElement1.value;
            const newStatus2 = selectElement2.value;

            // Intentar guardar y luego cerrar el modal
            try {
                 console.log("Calling updateDayStatus...");
                 await updateDayStatus(selectedDateForEdit, newStatus1, newStatus2);
                 console.log("UpdateDayStatus completed, attempting to close modal...");
            } catch (error) {
                 console.error("Error occurred during updateDayStatus:", error);
                 // Aqu√≠ podr√≠as mostrar un mensaje de error al usuario si lo deseas
                 // alert("Error al guardar los cambios. Revisa la consola.");
            } finally {
                 // Cerrar editor SIEMPRE despu√©s de intentar guardar
                 if (dayEditorModal) {
                     dayEditorModal.classList.remove('visible');
                     console.log("Edit modal closed.");
                 }
                 selectedDateForEdit = null; // Limpiar la fecha seleccionada
            }
        });


        dayEditorCancelBtn.addEventListener('click', () => { if (dayEditorModal) dayEditorModal.classList.remove('visible'); selectedDateForEdit = null; });
        dayEditorCloseBtn.addEventListener('click', () => { if (dayEditorModal) dayEditorModal.classList.remove('visible'); selectedDateForEdit = null; });
        dayEditorModal.addEventListener('click', (event) => { if (event.target === dayEditorModal) { dayEditorModal.classList.remove('visible'); selectedDateForEdit = null; } });

         document.addEventListener('keydown', (event) => {
              if (event.key === 'Escape') {
                  if (dayEditorModal && dayEditorModal.classList.contains('visible')) { dayEditorModal.classList.remove('visible'); selectedDateForEdit = null; }
                  else if (monthModal && monthModal.classList.contains('visible')) { monthModal.classList.remove('visible'); }
              }
         });

        // --- Inicializaci√≥n App ---
        async function initApp() {
            console.log(`Iniciando calendario con Firebase`);
            const essentialElementsExist = calendarAppDiv && calendarContainer && monthModal && dayEditorModal && monthModalBody && statusSelectionDiv1 && statusSelectionDiv2;
            if (!essentialElementsExist) {
                console.error("Error cr√≠tico: Faltan elementos DOM esenciales.");
                calendarAppDiv.innerHTML = '<p class="text-red-600 font-bold text-center p-4">Error: No se pudo iniciar el calendario.</p>';
                return;
            }

            dayData = await fetchDataForYear(displayedYear);
            setupRealtimeListener(displayedYear);
            calendarAppDiv.style.display = 'block';
            renderAnnualCalendar(displayedYear);

            const currentActualMonth = today.getMonth();
            const currentActualYear = today.getFullYear();
            if (displayedYear === currentActualYear) {
               console.log(`Abriendo modal mes actual: ${monthNames[currentActualMonth]} ${currentActualYear}`);
               openMonthModal(currentActualYear, currentActualMonth);
            } else {
                console.log(`A√±o mostrado (${displayedYear}) != a√±o actual (${currentActualYear}). No se abre modal mes actual.`);
            }
        }

        // --- Ejecuci√≥n Inicial ---
        document.addEventListener('DOMContentLoaded', initApp);

    </script>

</body>
</html>
